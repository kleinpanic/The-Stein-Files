<section class="hero">
  <div class="hero-text">
    <p class="eyebrow"><a href="people.html">‚Üê Back to All People</a></p>
    <h1 id="personName">Loading...</h1>
    <p id="personSummary">Document mentions and timeline</p>
  </div>
</section>

<section class="person-overview">
  <div class="stats-row">
    <div class="stat-box">
      <div class="stat-number" id="mentionCount">0</div>
      <div class="stat-label">Total Mentions</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="categoryCount">0</div>
      <div class="stat-label">Document Types</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="timelineSpan">‚Äî</div>
      <div class="stat-label">Timeline Span</div>
    </div>
  </div>
</section>

<section class="person-categories-section">
  <h2>Document Type Breakdown</h2>
  <div id="categoriesBreakdown" class="categories-breakdown"></div>
</section>

<section class="person-timeline-section">
  <h2>Timeline of Mentions</h2>
  <div class="timeline-controls">
    <label for="timelineSortOrder">Sort:</label>
    <select id="timelineSortOrder" class="inline-select">
      <option value="desc">Newest First</option>
      <option value="asc">Oldest First</option>
    </select>
  </div>
  <div id="timeline" class="timeline"></div>
</section>

<section class="person-documents-section">
  <h2>All Documents</h2>
  <div class="search-input">
    <input id="docSearch" type="search" placeholder="Search within this person's documents..." />
    <label for="docFilterCategory">Filter by type:</label>
    <select id="docFilterCategory" class="inline-select">
      <option value="">All Types</option>
    </select>
  </div>
  <div id="documentsList" class="documents-list"></div>
</section>

<style>
.eyebrow a {
  color: #0066cc;
  text-decoration: none;
}

.eyebrow a:hover {
  text-decoration: underline;
}

.person-overview {
  margin: 2rem 0;
}

.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.stat-box {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: #0066cc;
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.person-categories-section,
.person-timeline-section,
.person-documents-section {
  margin: 3rem 0;
}

.person-categories-section h2,
.person-timeline-section h2,
.person-documents-section h2 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
  color: #333;
}

.categories-breakdown {
  display: grid;
  gap: 0.75rem;
}

.category-bar {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.category-bar-label {
  min-width: 180px;
  font-size: 0.95rem;
  color: #333;
}

.category-bar-visual {
  flex: 1;
  background: #f0f0f0;
  height: 28px;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.category-bar-fill {
  background: linear-gradient(90deg, #0066cc, #0052a3);
  height: 100%;
  display: flex;
  align-items: center;
  padding: 0 0.75rem;
  color: white;
  font-size: 0.85rem;
  font-weight: 600;
  transition: width 0.5s ease-out;
}

.timeline-controls {
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.timeline {
  max-width: 1000px;
}

.timeline-year {
  margin: 2rem 0;
}

.timeline-year-header {
  font-size: 1.3rem;
  font-weight: 600;
  color: #0066cc;
  padding: 0.5rem 0;
  border-bottom: 2px solid #0066cc;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.timeline-year-count {
  background: #0066cc;
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.9rem;
}

.timeline-doc {
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  background: white;
  transition: all 0.2s;
}

.timeline-doc:hover {
  border-color: #0066cc;
  box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
}

.timeline-doc-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 0.5rem;
}

.timeline-doc-title {
  font-weight: 600;
  color: #0066cc;
  font-size: 1rem;
  text-decoration: none;
  flex: 1;
}

.timeline-doc-title:hover {
  text-decoration: underline;
}

.timeline-doc-date {
  color: #666;
  font-size: 0.85rem;
  white-space: nowrap;
}

.timeline-doc-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.85rem;
  color: #666;
  flex-wrap: wrap;
}

.timeline-doc-meta span {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.doc-category-badge {
  background: #f0f0f0;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.8rem;
  color: #333;
}

.documents-list {
  margin-top: 1.5rem;
}

.search-input {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.search-input input {
  flex: 1;
  min-width: 250px;
}

.inline-select {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .stats-row {
    grid-template-columns: 1fr;
  }
  
  .category-bar {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .category-bar-label {
    min-width: auto;
  }
  
  .category-bar-visual {
    width: 100%;
  }
}
</style>

<script>
let currentPersonData = null;

async function loadPersonData() {
  try {
    // Extract person slug from URL (assumes /people/slug.html)
    const path = window.location.pathname;
    const match = path.match(/people\/([^/]+)\.html/);
    if (!match) {
      throw new Error('Invalid person page URL');
    }
    const slug = match[1];
    
    // Load person data
    const response = await fetch(`../data/derived/people/${slug}.json`);
    currentPersonData = await response.json();
    
    renderPersonPage();
  } catch (error) {
    console.error('Failed to load person data:', error);
    document.getElementById('personName').textContent = 'Error loading person data';
  }
}

function renderPersonPage() {
  const data = currentPersonData;
  
  // Update header
  document.getElementById('personName').textContent = data.name;
  document.getElementById('personSummary').textContent = 
    `Mentioned in ${data.mention_count} documents across ${data.categories.length} document types`;
  
  // Update stats
  document.getElementById('mentionCount').textContent = data.mention_count;
  document.getElementById('categoryCount').textContent = data.categories.length;
  
  // Calculate timeline span
  const years = Object.keys(data.timeline).filter(y => y !== 'Unknown').map(Number).filter(y => y < 9999);
  if (years.length > 0) {
    const minYear = Math.min(...years);
    const maxYear = Math.max(...years);
    if (minYear === maxYear) {
      document.getElementById('timelineSpan').textContent = minYear;
    } else {
      document.getElementById('timelineSpan').textContent = `${minYear}‚Äì${maxYear}`;
    }
  } else {
    document.getElementById('timelineSpan').textContent = 'Unknown';
  }
  
  // Render categories breakdown
  renderCategoriesBreakdown();
  
  // Render timeline
  renderTimeline();
  
  // Render documents list
  renderDocumentsList();
  
  // Populate category filter
  populateCategoryFilter();
}

function renderCategoriesBreakdown() {
  const container = document.getElementById('categoriesBreakdown');
  const data = currentPersonData;
  const maxCount = data.categories[0][1]; // Highest count
  
  container.innerHTML = data.categories.map(([category, count]) => {
    const percentage = (count / maxCount) * 100;
    const displayCategory = category || 'Uncategorized';
    return `
      <div class="category-bar">
        <div class="category-bar-label">${displayCategory}</div>
        <div class="category-bar-visual">
          <div class="category-bar-fill" style="width: ${percentage}%">${count}</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderTimeline(sortOrder = 'desc') {
  const container = document.getElementById('timeline');
  const data = currentPersonData;
  
  // Sort years
  const years = Object.keys(data.timeline).sort((a, b) => {
    if (a === 'Unknown') return 1;
    if (b === 'Unknown') return -1;
    return sortOrder === 'desc' ? b - a : a - b;
  });
  
  container.innerHTML = years.map(year => {
    const docs = data.timeline[year];
    const sortedDocs = sortOrder === 'desc' ? [...docs].reverse() : docs;
    
    return `
      <div class="timeline-year">
        <div class="timeline-year-header">
          <span>${year}</span>
          <span class="timeline-year-count">${docs.length} docs</span>
        </div>
        ${sortedDocs.map(doc => renderTimelineDoc(doc)).join('')}
      </div>
    `;
  }).join('');
}

function renderTimelineDoc(doc) {
  const category = doc.category || 'uncategorized';
  return `
    <div class="timeline-doc">
      <div class="timeline-doc-header">
        <a href="documents/${doc.id}.html" class="timeline-doc-title">${doc.title}</a>
        <div class="timeline-doc-date">${doc.date}</div>
      </div>
      <div class="timeline-doc-meta">
        <span class="doc-category-badge">${category}</span>
        <span>üìÑ ${doc.pages} pages</span>
        ${doc.tags && doc.tags.length > 0 ? `<span>üè∑Ô∏è ${doc.tags.join(', ')}</span>` : ''}
      </div>
    </div>
  `;
}

function renderDocumentsList(searchTerm = '', filterCategory = '') {
  const container = document.getElementById('documentsList');
  const data = currentPersonData;
  
  let docs = data.documents;
  
  // Apply search filter
  if (searchTerm) {
    const term = searchTerm.toLowerCase();
    docs = docs.filter(doc => 
      doc.title.toLowerCase().includes(term) ||
      (doc.category && doc.category.toLowerCase().includes(term))
    );
  }
  
  // Apply category filter
  if (filterCategory) {
    docs = docs.filter(doc => doc.category === filterCategory);
  }
  
  if (docs.length === 0) {
    container.innerHTML = '<div class="state-banner empty">No documents match your filters.</div>';
    return;
  }
  
  container.innerHTML = docs.map(doc => renderTimelineDoc(doc)).join('');
}

function populateCategoryFilter() {
  const select = document.getElementById('docFilterCategory');
  const data = currentPersonData;
  
  data.categories.forEach(([category, count]) => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = `${category || 'Uncategorized'} (${count})`;
    select.appendChild(option);
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  loadPersonData();
  
  document.getElementById('timelineSortOrder').addEventListener('change', (e) => {
    renderTimeline(e.target.value);
  });
  
  document.getElementById('docSearch').addEventListener('input', (e) => {
    const searchTerm = e.target.value;
    const filterCategory = document.getElementById('docFilterCategory').value;
    renderDocumentsList(searchTerm, filterCategory);
  });
  
  document.getElementById('docFilterCategory').addEventListener('change', (e) => {
    const searchTerm = document.getElementById('docSearch').value;
    const filterCategory = e.target.value;
    renderDocumentsList(searchTerm, filterCategory);
  });
});
</script>
