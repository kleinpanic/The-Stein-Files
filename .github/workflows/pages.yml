name: Deploy Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout (without LFS)
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Cache LFS objects
        uses: actions/cache@v4
        id: lfs-cache
        with:
          path: .git/lfs
          # Use sha in the key so caches can be updated when new LFS objects are added.
          # Restore key pulls the most recent cache for this branch.
          key: lfs-v2-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            lfs-v2-${{ github.ref_name }}-

      - name: Pull LFS files
        id: lfs-pull
        continue-on-error: true
        run: |
          git lfs install
          # Always pull: if objects are already in the restored cache, this should be a no-op.
          # If new LFS objects were added in this commit, only the missing ones are downloaded.
          git lfs pull
          echo "lfs_available=true" >> $GITHUB_OUTPUT

      - name: Check LFS status
        id: lfs-status
        run: |
          if [ "${{ steps.lfs-pull.outcome }}" == "success" ]; then
            echo "mirror_mode=1" >> $GITHUB_OUTPUT
            echo "✅ LFS files available - enabling mirror mode"
          else
            echo "mirror_mode=0" >> $GITHUB_OUTPUT
            echo "⚠️ LFS unavailable - PDFs will load from source URLs"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python dependencies
        run: make setup

      - name: Check source links
        run: make check-links

      - name: Run tests
        run: make test

      - name: Build site
        run: make build
        env:
          EPPIE_MIRROR_MODE: ${{ steps.lfs-status.outputs.mirror_mode }}

      # GitHub Pages artifacts have a hard 1GB limit. When mirror mode is enabled
      # (LFS PDFs copied into dist), dist can exceed that limit and deployments may
      # start failing nondeterministically. Guardrail: if dist is too large, rebuild
      # with mirroring disabled so PDFs load from source URLs.
      - name: Check dist size
        id: dist-size
        run: |
          bytes=$(du -sb dist | awk '{print $1}')
          echo "bytes=$bytes" >> $GITHUB_OUTPUT
          echo "Dist size (bytes): $bytes"
          if [ "$bytes" -gt 950000000 ]; then
            echo "too_big=1" >> $GITHUB_OUTPUT
            echo "::warning::dist is >950MB ($bytes bytes). This is near/over the 1GB Pages artifact limit. Will rebuild without mirroring."
          else
            echo "too_big=0" >> $GITHUB_OUTPUT
          fi

      - name: Rebuild site without mirroring (Pages size guardrail)
        if: steps.dist-size.outputs.too_big == '1'
        run: |
          rm -rf dist
          EPPIE_MIRROR_MODE=0 make build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
